// Key Ä‘á»ƒ lÆ°u trong LocalStorage 
const CART_KEY = "MY_APP_CART";

// HÃ m láº¥y giá» hÃ ng tá»« LocalStorage
function getCart() {
    const stored = localStorage.getItem(CART_KEY);
    return stored ? JSON.parse(stored) : [];
}

// HÃ m lÆ°u giá» hÃ ng
function saveCart(cart) {
    localStorage.setItem(CART_KEY, JSON.stringify(cart));
    updateCartBadge(); // Cáº­p nháº­t sá»‘ lÆ°á»£ng trÃªn menu
}

// HÃ m thÃªm vÃ o giá» (MÃ´ phá»ng addToCart trong Context)
function addToCart(product) {
    let cart = getCart();
    // Kiá»ƒm tra sáº£n pháº©m Ä‘Ã£ cÃ³ chÆ°a
    const existingItem = cart.find(item => item.product.id === product.id);
    
    if (existingItem) {
        existingItem.quantity += 1;
    } else {
        cart.push({ product: product, quantity: 1 });
    }
    
    saveCart(cart);
    updateCartBadge();
    alert(`ÄÃ£ thÃªm "${product.title}" vÃ o giá» hÃ ng!`);
}

// HÃ m cáº­p nháº­t sá»‘ lÆ°á»£ng badge trÃªn menu
function updateCartBadge() {
    const cart = getCart();
    const totalQty = cart.reduce((sum, item) => sum + item.quantity, 0);
    
    const badge = document.getElementById('cart-badge');
    if (badge) {
        badge.innerText = totalQty;
        badge.style.display = totalQty > 0 ? 'inline-block' : 'none';
    }
}

// HÃ m format tiá»n tá»‡
function formatCurrency(amount) {
    return "$" + parseFloat(amount).toFixed(2);
}

// --- LOGIC CHO TRANG CART.HTML ---
function renderCartPage() {
    const cart = getCart();
    const container = document.getElementById('cart-container');
    const emptyMsg = document.getElementById('cart-empty');
    const cartTable = document.getElementById('cart-table');
    const totalPriceEl = document.getElementById('total-price');

    if (!container) return; // KhÃ´ng pháº£i trang cart thÃ¬ thoÃ¡t

    if (cart.length === 0) {
        emptyMsg.style.display = 'block';
        cartTable.style.display = 'none';
        return;
    }

    emptyMsg.style.display = 'none';
    cartTable.style.display = 'block';

    // Render danh sÃ¡ch
    const tbody = document.getElementById('cart-body');
    tbody.innerHTML = '';
    
    let total = 0;

    cart.forEach(item => {
        const p = item.product;
        const lineTotal = p.price * item.quantity;
        total += lineTotal;

        const row = `
            <tr>
                <td style="padding: 10px; display: flex; align-items: center; gap: 10px;">
                    <img src="${p.image || '/static/images/khongcoanh.png'}" width="50" height="50" style="object-fit: contain;">
                    <span>${p.title}</span>
                </td>
                <td>${formatCurrency(p.price)}</td>
                <td>
                    <button onclick="changeQty(${p.id}, -1)" class="btn-qty">-</button>
                    <span style="margin: 0 10px;">${item.quantity}</span>
                    <button onclick="changeQty(${p.id}, 1)" class="btn-qty">+</button>
                </td>
                <td style="color: #d32f2f; font-weight: bold;">${formatCurrency(lineTotal)}</td>
                <td>
                    <button onclick="removeItem(${p.id})" class="btn-remove">ðŸ—‘ XÃ³a</button>
                </td>
            </tr>
        `;
        tbody.innerHTML += row;
    });

    if (totalPriceEl) totalPriceEl.innerText = formatCurrency(total);
}

// HÃ m tÄƒng giáº£m sá»‘ lÆ°á»£ng
function changeQty(productId, delta) {
    let cart = getCart();
    const item = cart.find(i => i.product.id === productId);
    
    if (item) {
        item.quantity += delta;
        if (item.quantity <= 0) {
            cart = cart.filter(i => i.product.id !== productId);
        }
    }
    
    saveCart(cart);
    renderCartPage(); // Render láº¡i trang
}

// HÃ m xÃ³a sáº£n pháº©m
function removeItem(productId) {
    if(!confirm("Báº¡n cÃ³ cháº¯c muá»‘n xÃ³a sáº£n pháº©m nÃ y?")) return;
    let cart = getCart();
    cart = cart.filter(i => i.product.id !== productId);
    saveCart(cart);
    renderCartPage();
}

// Khá»Ÿi cháº¡y khi load trang
document.addEventListener('DOMContentLoaded', () => {
    updateCartBadge();
    renderCartPage();
});