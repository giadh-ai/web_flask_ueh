{% extends "index.html" %}

{% block content %}
<div class="chat-wrapper">
    <div class="chat-box">
        <div class="chat-header">
            <h3>ü§ñ Chatbot UEH AI</h3>
        </div>

        <div id="message-list" class="message-list">
            <div class="message-row start">
                <div class="bubble bot">
                    Xin ch√†o! T√¥i l√† tr·ª£ l√Ω ·∫£o AI. T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n?
                </div>
            </div>
        </div>

        <div class="input-area">
            <input type="text" id="chat-input" placeholder="Nh·∫≠p tin nh·∫Øn..." autocomplete="off">
            <button id="btn-send" onclick="sendMessage()">G·ª≠i</button>
        </div>
    </div>
</div>

<style>
    /* CSS chuy·ªÉn t·ª´ React styles sang */
    .chat-wrapper {
        display: flex; justify-content: center; align-items: center;
        height: 80vh; background-color: #f0f2f5; padding: 20px;
    }
    .chat-box {
        width: 100%; max-width: 600px; height: 100%;
        background-color: #fff; border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        display: flex; flex-direction: column; overflow: hidden;
    }
    .chat-header {
        padding: 16px; background-color: #2196F3; color: white;
        text-align: center; border-bottom: 1px solid #ddd;
    }
    .message-list {
        flex: 1; padding: 20px; overflow-y: auto;
        display: flex; flex-direction: column; gap: 10px;
    }
    .message-row {
        display: flex; width: 100%;
    }
    .message-row.end { justify-content: flex-end; }   /* Tin nh·∫Øn ng∆∞·ªùi d√πng */
    .message-row.start { justify-content: flex-start; } /* Tin nh·∫Øn Bot */

    .bubble {
        max-width: 75%; padding: 10px 15px; border-radius: 15px;
        font-size: 15px; line-height: 1.4; word-wrap: break-word; white-space: pre-wrap;
    }
    .bubble.user { background-color: #007bff; color: #fff; border-bottom-right-radius: 2px; }
    .bubble.bot { background-color: #e9ecef; color: #000; border-bottom-left-radius: 2px; }
    .bubble.loading { font-style: italic; color: #666; background: #f0f0f0; }

    .input-area {
        padding: 15px; border-top: 1px solid #eee;
        display: flex; gap: 10px; background-color: #fafafa;
    }
    #chat-input {
        flex: 1; padding: 12px; border-radius: 20px;
        border: 1px solid #ccc; outline: none; font-size: 16px;
    }
    #btn-send {
        padding: 10px 20px; color: white; border: none;
        border-radius: 20px; font-weight: bold; font-size: 16px;
        background-color: #007bff; cursor: pointer; transition: background 0.2s;
    }
    #btn-send:disabled { background-color: #ccc; cursor: not-allowed; }
</style>

<script>
    const messageList = document.getElementById('message-list');
    const inputField = document.getElementById('chat-input');
    const sendBtn = document.getElementById('btn-send');

    // H√†m cu·ªôn xu·ªëng cu·ªëi
    function scrollToBottom() {
        messageList.scrollTop = messageList.scrollHeight;
    }

    // X·ª≠ l√Ω s·ª± ki·ªán Enter
    inputField.addEventListener('keypress', function (e) {
        if (e.key === 'Enter') sendMessage();
    });

    async function sendMessage() {
        const text = inputField.value.trim();
        if (!text) return;

        // 1. Hi·ªÉn th·ªã tin nh·∫Øn User
        appendMessage(text, 'user');
        inputField.value = '';
        inputField.disabled = true;
        sendBtn.disabled = true;

        // 2. Hi·ªÉn th·ªã "ƒêang suy nghƒ©..."
        const loadingId = appendLoading();
        scrollToBottom();

        try {
            // 3. G·ªçi v·ªÅ Server Python (Thay v√¨ g·ªçi tr·ª±c ti·∫øp Google)
            const response = await fetch('/api/chat-process', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: text })
            });

            const data = await response.json();

            // 4. X√≥a loading v√† hi·ªán tin nh·∫Øn Bot
            removeMessage(loadingId);
            
            if (response.ok) {
                appendMessage(data.reply, 'bot');
            } else {
                appendMessage("‚ùå L·ªói: " + data.reply, 'bot');
            }

        } catch (error) {
            removeMessage(loadingId);
            appendMessage("‚ùå M·∫•t k·∫øt n·ªëi t·ªõi server.", 'bot');
            console.error(error);
        } finally {
            inputField.disabled = false;
            sendBtn.disabled = false;
            inputField.focus();
            scrollToBottom();
        }
    }

    // H√†m v·∫Ω tin nh·∫Øn l√™n m√†n h√¨nh
    function appendMessage(text, role) {
        const row = document.createElement('div');
        row.className = `message-row ${role === 'user' ? 'end' : 'start'}`;
        
        const bubble = document.createElement('div');
        bubble.className = `bubble ${role}`;
        bubble.textContent = text; // D√πng textContent ƒë·ªÉ ch·ªëng XSS

        row.appendChild(bubble);
        messageList.appendChild(row);
    }

    // H√†m t·∫°o hi·ªáu ·ª©ng loading
    function appendLoading() {
        const id = 'loading-' + Date.now();
        const row = document.createElement('div');
        row.id = id;
        row.className = 'message-row start';
        row.innerHTML = `<div class="bubble loading">Bot ƒëang suy nghƒ©...</div>`;
        messageList.appendChild(row);
        return id;
    }

    function removeMessage(id) {
        const el = document.getElementById(id);
        if (el) el.remove();
    }
</script>
{% endblock %}